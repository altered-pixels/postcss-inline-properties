"use strict";var e=require("@csstools/cascade-layer-name-parser"),t=require("postcss-value-parser"),r=require("@csstools/utilities");const n=e.parse("csstools-implicit-layer")[0];function collectCascadeLayerOrder(t){const r=new Map,a=new Map,s=[];t.walkAtRules((t=>{if("layer"!==t.name.toLowerCase())return;{let e=t.parent;for(;e;){if("atrule"!==e.type||"layer"!==e.name.toLowerCase()){if(e===t.root())break;return}e=e.parent}}let o;if(t.nodes)o=normalizeLayerName(t.params,1);else{if(!t.params.trim())return;o=t.params}let i=e.parse(o);if(i?.length){{let e=t.parent;for(;e&&"atrule"===e.type&&"layer"===e.name.toLowerCase();){const t=a.get(e);t?(i=i.map((e=>t.concat(e))),e=e.parent):e=e.parent}}if(e.addLayerToModel(s,i),t.nodes){const e=i[0].concat(n);r.set(t,e),a.set(t,i[0])}}}));for(const t of r.values())e.addLayerToModel(s,[t]);const o=new WeakMap;for(const[e,t]of r)o.set(e,s.findIndex((e=>t.equal(e))));return o}function normalizeLayerName(e,t){return e.trim()?e:"csstools-anon-layer--"+t++}const a=/(?:!\s*)?postcss-inline-properties:\s*off\b/i,s=new WeakMap;function isBlockIgnored(e){if(!e||!e.nodes)return!1;if(s.has(e))return s.get(e);const t=e.some((e=>isIgnoreComment(e,a)));return s.set(e,t),t}const o=/(?:!\s*)?postcss-inline-properties:\s*ignore\s+next\b/i;function isDeclarationIgnored(e){return!!e&&(!!isBlockIgnored(e.parent)||isIgnoreComment(e.prev(),o))}function isIgnoreComment(e,t){return!!e&&"comment"===e.type&&t.test(e.text)}const i=new Set(["layer"]);function isProcessableRule(e){let t=e.parent;for(;t;){if("atrule"===t.type&&!i.has(t.name.toLowerCase()))return!1;t=t.parent}return!0}const l=/^html$/i,c=/^:where\(html\)$/i,u=/^:root$/i,p=/^:where\(:root\)$/i,f=/(html|:root)/i,d=/^var$/i;function isVarFunction(e){return"function"===e.type&&d.test(e.value)&&e.nodes?.length>0}const v=/\bvar\(/i;function parseOrCached(e,r){let n=r.get(e);return n||(n=t(e),r.set(e,n),n)}function toposort(e,t){let r=e.length;const n=new Array(r),a={};let s=r;const o=makeOutgoingEdges(t),i=makeNodesHash(e);for(;s--;)a[s]||visit(e[s],s,new Set);return n;function visit(e,t,s){if(s.has(e)){let t;try{t=", node was:"+JSON.stringify(e)}catch{t=""}throw new Error("Cyclic dependency"+t)}if(!i.has(e))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(e));if(a[t])return;a[t]=!0;const l=Array.from(o.get(e)||new Set);if(t=l.length){s.add(e);do{const e=l[--t];visit(e,i.get(e),s)}while(t);s.delete(e)}n[--r]=e}}function removeCyclicReferences(e,t){const r=new Set;for(;e.size>0;){const n=findCyclicNode(Array.from(e.keys()),t);if(!n)return r;e.delete(n),r.add(n),t=t.filter((e=>-1===e.indexOf(n)))}return r}function findCyclicNode(e,t){let r=e.length;const n=new Array(r),a={};let s=r;const o=makeOutgoingEdges(t),i=makeNodesHash(e);for(;s--;)if(!a[s]){const t=visit(e[s],s,new Set);if(!t)continue;return t}function visit(e,t,s){if(s.has(e))return e;if(!i.has(e))return;if(a[t])return;a[t]=!0;const l=Array.from(o.get(e)||new Set);if(t=l.length){s.add(e);do{const e=l[--t],r=visit(e,i.get(e),s);if(r)return r}while(t);s.delete(e)}n[--r]=e}}function makeOutgoingEdges(e){const t=new Map;for(let r=0,n=e.length;r<n;r++){const n=e[r];t.has(n[0])||t.set(n[0],new Set),t.has(n[1])||t.set(n[1],new Set),t.get(n[0]).add(n[1])}return t}function makeNodesHash(e){const t=new Map;for(let r=0,n=e.length;r<n;r++)t.set(e[r],r);return t}function parseVarFunction(e){let t,r,n=!1;for(const a of e.nodes)if(t||"word"!==a.type)if(!t||n||"div"!==a.type||","!==a.value){if(n&&Array.isArray(r))r.push(a);else if("space"!==a.type&&("div"!==a.type||""!==a.value.trim()))return}else n=!0,r=[];else t=a;if(t)return{name:t,fallback:r}}function transformValueAST(e,r){return e.nodes?.length?(walk(e.nodes,((e,n,a)=>{if(!isVarFunction(e))return;const s=parseVarFunction(e);if(!s)return;let o=!1;s.fallback&&t.walk(s.fallback,(e=>{if(!isVarFunction(e))return;const t=parseVarFunction(e);return t?t.fallback||r.has(t.name.value)?void 0:(o=!0,!1):void 0}));let i=r.get(s.name.value)?.nodes;i||!s.fallback||o||(i=s.fallback),void 0!==i&&(i.length?a.splice(n,1,...i):a.splice(n,1,{type:"div",value:" ",before:"",after:"",sourceIndex:e.sourceIndex,sourceEndIndex:e.sourceEndIndex}))})),t.stringify(e.nodes)):""}function walk(e,t){let r,n,a;for(r=0,n=e.length;r<n;r+=1)a=e[r],"function"===a.type&&Array.isArray(a.nodes)&&walk(a.nodes,t),t(a,r,e),n=e.length}const w=/^initial$/i;function isInitial(e){const t=e.nodes.filter((e=>"comment"!==e.type&&"space"!==e.type));return 1===t.length&&("word"===t[0].type&&w.test(t[0].value))}function buildCustomPropertiesMap(e,r,n){if(!e.size)return r;const a=new Map(r);{const s=[];for(const[o,i]of e.entries()){const l=parseOrCached(i,n);let c=!1;t.walk(l.nodes,(t=>{if(!isVarFunction(t))return;const n=parseVarFunction(t);n&&(n.fallback||e.has(n.name.value)||r.has(n.name.value)?s.push([n.name.value,o]):c=!0)})),c||a.set(o,l)}removeCyclicReferences(a,s)}{const e=[];for(const[r,n]of a.entries())t.walk(n.nodes,(t=>{if(!isVarFunction(t))return;const n=parseVarFunction(t);n&&(n.fallback||a.has(n.name.value)?e.push([n.name.value,r]):a.delete(r))}));for(let t=0;t<e.length;t++){const[r,n]=e[t];a.has(r)&&a.has(n)||e.splice(t--,1)}const r=toposort(Array.from(a.keys()),e);for(const e of r){const t=a.get(e);if(!t)continue;const r=parseOrCached(transformValueAST(t,a),n);a.set(e,r)}}for(const[e,t]of a.entries())isInitial(t)&&a.delete(e);return a}function getCustomPropertiesFromRoot(e,t){const r=new Map,n=new Map,a=collectCascadeLayerOrder(e);return e.walkRules((e=>{f.test(e.selector)&&e.nodes?.length&&isProcessableRule(e)&&(isBlockIgnored(e)||e.selectors.forEach((t=>{let s=-1;if(c.test(t)||p.test(t))s=0;else if(l.test(t))s=1;else{if(!u.test(t))return;s=2}const o=(f=a,((i=e).parent&&"atrule"===i.parent.type&&"layer"===i.parent.name.toLowerCase()?f.has(i.parent)?f.get(i.parent)+1:0:1e7)+10+s);var i,f;e.each((e=>{if("decl"!==e.type)return;if(!e.variable||isDeclarationIgnored(e))return;if("initial"===e.value.toLowerCase().trim())return;const t=n.get(e.prop)??-1;o>=t&&(n.set(e.prop,o),r.set(e.prop,e.value))}))})))})),buildCustomPropertiesMap(r,new Map,t)}function getCustomPropertiesFromSiblings(e,t,r){if(!e.parent)return t;const n=new Map;return e.parent.each((t=>{"decl"===t.type&&t.variable&&e!==t&&(isDeclarationIgnored(t)||n.set(t.prop,t.value))})),n.size?buildCustomPropertiesMap(n,t,r):t}function transformProperties(e,r,n){if(isTransformableDecl(e,n)&&!isDeclarationIgnored(e)){const a=e.value,s=transformValueAST(t(a),r);if(s===a)return;if(parentHasExactFallback(e,s))return void(n.preserve||e.remove());if(n.preserve){const t=e.cloneBefore({value:s});hasTrailingComment(t)&&t.raws?.value&&(t.raws.value.value=t.value.replace(m,"$1"),t.raws.value.raw=t.raws.value.value+t.raws.value.raw.replace(m,"$2"))}else e.value=s,hasTrailingComment(e)&&e.raws?.value&&(e.raws.value.value=e.value.replace(m,"$1"),e.raws.value.raw=e.raws.value.value+e.raws.value.raw.replace(m,"$2"))}}const isTransformableDecl=(e,t)=>(t.includeVars||!e.variable)&&e.value.includes("--")&&e.value.toLowerCase().includes("var("),hasTrailingComment=e=>"value"in Object(Object(e.raws).value)&&"raw"in(e.raws?.value??{})&&m.test(e.raws.value?.raw??""),m=/^([\W\w]+)(\s*\/\*[\W\w]+?\*\/)$/;function parentHasExactFallback(e,t){if(!e||!e.parent)return!1;let r=!1;const n=e.parent.index(e);return e.parent.each(((a,s)=>a!==e&&(!(s>=n)&&void("decl"===a.type&&a.prop.toLowerCase()===e.prop.toLowerCase()&&a.value===t&&(r=!0))))),r}const g=/\bvar\(|\(top: var\(--f\)/i,creator=e=>{const t="preserve"in Object(e)&&Boolean(e?.preserve);let n=e?.matchers??[/^.*(var\([a-zA-Z0-9-_]+\)).*$/];Array.isArray(n)||(n=[n]);const a="includeVars"in Object(e)&&Boolean(e?.includeVars);return{postcssPlugin:"postcss-inline-properties",prepare(){let e=new Map;const s=new WeakMap,o=new Map;return{postcssPlugin:"postcss-inline-properties",Once(t){e=getCustomPropertiesFromRoot(t,o)},Declaration(i){if(!v.test(i.value))return;if(!n.some((e=>e.test(i.value))))return;if(r.hasSupportsAtRuleAncestor(i,g))return;let l=e;t&&i.parent&&(l=s.get(i.parent)??getCustomPropertiesFromSiblings(i,e,o),s.set(i.parent,l)),transformProperties(i,l,{preserve:t,matchers:n,includeVars:a})}}}}};creator.postcss=!0,module.exports=creator;
